syntax = "proto3";

option java_multiple_files = true;
option java_package = "gkvs.proto";
option java_outer_classname = "GenericStoreProto";
option objc_class_prefix = "GKV";

package gkvs;

service GenericStore {

    rpc getHead(KeyOperation) returns (HeadResult) {}

    rpc multiGetHead(BatchKeyOperation) returns (BatchHeadResult) {}

    rpc getHeadAll(stream KeyOperation) returns (stream HeadResult) {}

    rpc get(KeyOperation) returns (RecordResult) {}

    rpc multiGet(BatchKeyOperation) returns (BatchRecordResult) {}

    rpc getAll(stream KeyOperation) returns (stream RecordResult) {}

    rpc scanHead(ScanOperation) returns (stream HeadResult) {}

    rpc scan(ScanOperation) returns (stream RecordResult) {}

    rpc put(PutOperation) returns (StatusResult) {}

    rpc compareAndPut(PutOperation) returns (StatusResult) {}

    rpc putAll(stream PutOperation) returns (stream StatusResult) {}

    rpc remove(KeyOperation) returns (StatusResult) {}

    rpc removeAll(stream KeyOperation) returns (stream StatusResult) {}

}

message Status {

    enum Code {
         SUCCESS = 0;
         SUCCESS_END_STREAM = 1;   // for streaming data, end stream marker
         SUCCESS_NOT_UPDATED = 2;  // for compare and put operation that is non-locking algorithm

         ERROR_RES_NOT_FOUND = 10; // not found: database, namespace, table, catalog, etc.
         ERROR_BAD_REQUEST = 11;   // invalid parameters in request
         ERROR_POLICY = 12;        // exists record for operation that requires record and vise versa
         ERROR_MIGRATION = 13;     // data or connections migration occur during operation
         ERROR_NETWORK = 14;       // all connection errors and network availability
         ERROR_AUTH = 15;          // security configuration and authentication
         ERROR_FORBIDDEN = 16;     // authorization
         ERROR_TIMEOUT = 17;       // all SLA errors
         ERROR_OVERLOAD = 18;      // all errors related to high load of operations, full queues and etc.
         ERROR_OVERFLOW = 19;      // all errors related to data space
         ERROR_LOCKED = 20;        // all tries to update data that was in pessimistic lock
         ERROR_ABORTED = 21;       // client aborted stream operation
         ERROR_UNSUPPORTED = 22;   // unsupported commands
         ERROR_DRIVER = 23;        // data access driver specific errors
         ERROR_IO = 24;            // file, serialization, network i/o errors
         ERROR_INTERNAL = 25;      // all unknown errors
    }

    Code code = 1;

    int32 errorCode = 10;
    string errorMessage = 11;
    string errorDetails = 12;   // place for stackTrace for Java

}

message StatusResult {

    Status status = 1;
    int64 sequenceNum = 2;
}

message Head {

    int64 version = 1;
    repeated string columnKey = 2;

}

message HeadResult {

    Status status = 1;
    int64 sequenceNum = 2;
    Key key = 3;
    Head head = 4;
}

message BatchHeadResult {

    repeated HeadResult result = 1;

}

message Record {

    int64 version = 1;
    map<string, bytes> columns = 2;

}

message RecordResult {

    Status status  = 1;
    int64 sequenceNum = 2;
    Key key = 3;
    Record record = 4;

}

message BatchRecordResult {

    repeated RecordResult result = 1;

}

message Key {

    string tableName = 1;

    oneof recordRef {
      string  recordKey = 2;
      bytes   recordHash = 3;
    }

    // optional, if not specified then all columns will be retrieved
    repeated string columnKey = 4;

}

message KeyResult {

   Status status  = 1;
   int64 sequenceNum = 2;
   Key key = 3;

}

message Operation {

   int32 timeoutMls = 1;
   fixed64 pit = 2;

}

message ScanOperation {

   Operation op = 1;
   string tableName = 2;
   bool includeKeyInResult = 3;

}

message KeyOperation {

   Operation op = 1;
   int64 sequenceNum = 2;
   Key key = 3;
   bool includeKeyInResult = 4;

}

message BatchKeyOperation {

   // gets max timeout for the batch
   repeated KeyOperation operation = 1;

}

message PutOperation {

   Operation op = 1;
   int64 sequenceNum = 2;
   Key key = 3;
   Record record = 4;
   int32 ttlSec = 5;

}
